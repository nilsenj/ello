<div class="flex flex-col h-screen bg-slate-50">
    <!-- App header -->
    <user-header class="shrink-0"></user-header>

    <!-- App body -->
    <div class="relative flex flex-1 overflow-hidden">
        <!-- Mobile backdrop -->
        <div
                *ngIf="sidebarOpen()"
                class="fixed inset-0 z-40 bg-black/40 backdrop-blur-sm md:hidden"
                (click)="toggleSidebar()"
        ></div>

        <!-- Sidebar WRAPPER (absolute on mobile, relative on desktop) -->
        <div
                class="
        absolute inset-y-0 left-0 z-50
        transform transition-transform duration-300 ease-out
        -translate-x-full
        md:relative md:z-0 md:translate-x-0
        pointer-events-none md:pointer-events-auto
      "
                [class.translate-x-0]="sidebarOpen()"
                [class.pointer-events-auto]="sidebarOpen()"
        >
            <!-- The actual sidebar component -->
            <workspace-sidebar
                    class="h-full w-64"
                    [workspaces]="workspaces()"
                    [selectedWorkspaceId]="selectedWorkspaceId()"
                    (workspaceSelected)="onWorkspaceSelected($event); toggleSidebar()"
                    (createWorkspace)="openCreateWorkspace()"
                    (openSettings)="openWorkspaceSettings($event)"
                    (openMembers)="openWorkspaceMembers($event)"
                    (openTemplates)="openTemplates()"
            ></workspace-sidebar>
        </div>

        <!-- Main content -->
        <main class="flex-1 overflow-y-auto">
            <div
                    *ngIf="!loading(); else loadingTpl"
                    class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8"
            >
                <!-- Starred boards -->
                <section *ngIf="starredBoards().length" class="mb-8">
                    <div class="flex items-center gap-2 mb-4 text-slate-700">
                        <lucide-icon [img]="StarIcon" class="w-5 h-5 text-yellow-500"></lucide-icon>
                        <h2 class="text-sm sm:text-base font-semibold">{{ tStarredBoards }}</h2>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100">
              {{ starredBoards().length }}
            </span>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
                        <a
                                *ngFor="let board of starredBoards()"
                                [routerLink]="['/b', board.id]"
                                class="relative group rounded-lg p-3 border border-slate-200 overflow-hidden transition hover:shadow-md"
                                [ngClass]="getBoardBackground(board)"
                        >
                            <div class="font-semibold text-sm sm:text-base relative z-10" [ngClass]="getBoardTextColor(board)">
                                {{ board.name }}
                            </div>

                            <button
                                    (click)="toggleStar($event, board.id)"
                                    class="absolute bottom-2 right-2 p-1.5 rounded-md bg-black/30 text-white hover:bg-black/50"
                            >
                                <lucide-icon [img]="StarIcon" class="w-4 h-4 text-yellow-300 fill-yellow-300"></lucide-icon>
                            </button>

                        </a>
                    </div>
                </section>

                <!-- Workspace -->
                <section *ngIf="selectedWorkspace() as ws" class="mb-10">
                    <div class="flex items-center gap-3 mb-4">
                        <div
                                class="w-8 h-8 rounded-md bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold"
                        >
                            {{ ws.name.charAt(0).toUpperCase() }}
                        </div>

                        <h2 class="text-base sm:text-lg font-semibold text-slate-900">
                            {{ ws.name }}
                        </h2>

                        <div class="ml-auto flex gap-2">
                            <button
                                    (click)="openWorkspaceMembers(ws)"
                                    class="px-3 py-1.5
        text-xs sm:text-sm
        inline-flex items-center gap-1.5
        rounded-md
        bg-slate-100
        hover:bg-slate-200
        text-slate-700
        transition"
                            >
                                <lucide-icon [img]="UsersIcon" class="w-3.5 h-3.5"></lucide-icon>
                                <span>{{ tMembers }}</span>
                            </button>

                            <button
                                    *ngIf="canEditWorkspace(ws)"
                                    (click)="openWorkspaceSettings(ws)"
                                    class="px-3 py-1.5
        text-xs sm:text-sm
        inline-flex items-center gap-1.5
        rounded-md
        bg-slate-100
        hover:bg-slate-200
        text-slate-700
        transition"
                            >
                                <lucide-icon [img]="SettingsIcon" class="w-3.5 h-3.5"></lucide-icon>
                                <span>{{ tSettings }}</span>
                            </button>

                            <label
                                    *ngIf="canEditWorkspace(ws)"
                                    class="px-3 py-1.5
        text-xs sm:text-sm
        inline-flex items-center gap-1.5
        rounded-md
        bg-slate-100
        hover:bg-slate-200
        text-slate-700
        transition
        cursor-pointer"
                            >
                                <lucide-icon [img]="UploadIcon" class="w-3.5 h-3.5"></lucide-icon>
                                <span>{{ tImportJson }}</span>
                                <input type="file" accept="application/json" class="hidden"
                                       (change)="importBoardToWorkspace($event, ws.id)">
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
                        <div
                                *ngFor="let board of getBoardsForWorkspace(ws.id)"
                                class="relative group rounded-lg p-3 border border-slate-200 overflow-hidden hover:shadow-md cursor-pointer"
                                [ngClass]="getBoardBackground(board)"
                                (click)="openBoard(board.id, $event)"
                        >
                            <div class="font-semibold text-sm sm:text-base relative z-10" [ngClass]="getBoardTextColor(board)">
                                {{ board.name }}
                            </div>

                            <button
                                    *ngIf="canArchiveBoard(ws)"
                                    type="button"
                                    data-stop-open
                                    (click)="requestArchiveBoard($event, board)"
                                    class="absolute top-2 right-2 p-1.5 rounded-md bg-black/30 text-white opacity-0 group-hover:opacity-100"
                            >
                                <lucide-icon [img]="ArchiveIcon" class="w-4 h-4"></lucide-icon>
                            </button>

                        </div>

                        <button
                                *ngIf="canCreateBoard(ws)"
                                (click)="openCreateBoard(ws.id)"
                                class="rounded-lg border border-dashed border-slate-300 bg-white flex flex-col items-center justify-center text-slate-500 hover:bg-slate-50 p-4"
                        >
                            <lucide-icon [img]="PlusIcon" class="w-5 h-5 mb-1"></lucide-icon>
                            <span class="text-sm font-medium">{{ tCreateBoard }}</span>
                        </button>
                    </div>
                </section>
            </div>

            <!-- Loading -->
            <ng-template #loadingTpl>
                <div class="max-w-6xl mx-auto px-4 py-8">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div *ngFor="let _ of [1,2,3,4]" class="h-24 rounded-lg skeleton-shimmer"></div>
                    </div>
                </div>
            </ng-template>
        </main>

        <!-- Mobile floating workspace toggle -->
        <button
                (click)="toggleSidebar()"
                aria-label="Toggle workspaces"
                class="
        md:hidden
        fixed bottom-4 right-4 z-[60]
        inline-flex items-center gap-2
        h-11 pl-2 pr-4
        rounded-full
        bg-white
        border border-slate-200
        shadow-lg
        text-slate-700
        hover:bg-slate-100
        active:scale-95
        transition
    "
        >
            <!-- Icon bubble -->
            <span
                    class="
            h-7 w-7
            flex items-center justify-center
            rounded-full
            bg-slate-100
            text-slate-600
        "
            >
        <lucide-icon
                [img]="sidebarOpen() ? XIcon : SettingsIcon"
                class="w-4 h-4"
        ></lucide-icon>
    </span>

            <!-- Label -->
            <span class="text-sm font-medium whitespace-nowrap">
        <span>{{ tWorkspaces }}</span>
    </span>
        </button>

    </div>
</div>

<!-- Modals -->
<board-create-modal></board-create-modal>
<workspace-create-modal></workspace-create-modal>
<workspace-settings-modal></workspace-settings-modal>
<workspace-settings-advanced-modal></workspace-settings-advanced-modal>
<workspace-members-modal></workspace-members-modal>
<templates-modal></templates-modal>

<!-- Archive confirmation modal -->
<section *ngIf="boardToArchive()"
         class="fixed inset-0 z-[1000] grid place-items-center bg-black/50 backdrop-blur-sm"
         (mousedown)="closeArchiveModal()" role="dialog" aria-modal="true">
    <div class="w-[min(90vw,420px)] bg-white rounded-xl shadow-2xl flex flex-col"
         (mousedown)="$event.stopPropagation()">
        <header class="px-5 py-3 border-b border-slate-200 flex items-center justify-between">
            <span class="font-semibold text-[15px] text-slate-800">{{ tArchiveTitle }}</span>
            <button class="inline-flex h-8 w-8 items-center justify-center rounded-md hover:bg-slate-100"
                    (click)="closeArchiveModal()" aria-label="Close">
                <lucide-icon [img]="XIcon" class="h-4 w-4 text-slate-600"></lucide-icon>
            </button>
        </header>

        <div class="p-5 text-sm text-slate-600">
            <p>{{ archivePrompt() }}</p>
            <p class="mt-2">{{ tArchiveHint }}</p>
        </div>

        <footer class="border-t border-slate-200 bg-white px-4 py-3 flex justify-end gap-2 rounded-b-xl">
            <button
                    class="inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50"
                    (click)="closeArchiveModal()">
                <span>{{ tCancel }}</span>
            </button>
            <button
                    class="inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-sm text-white hover:bg-red-700"
                    (click)="confirmArchive()">
                <span>{{ tArchiveConfirm }}</span>
            </button>
        </footer>
    </div>
</section>
