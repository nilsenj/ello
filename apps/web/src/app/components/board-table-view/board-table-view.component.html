<div class="flex flex-col h-full bg-white text-sm text-gray-700">
    <!-- Table Header -->
    <div
        class="flex items-center bg-gray-50 border-b font-semibold text-xs text-gray-500 uppercase tracking-wider sticky top-0 z-10">
        <div class="flex-1 px-4 py-2 cursor-pointer hover:bg-gray-100 flex items-center gap-1 border-r"
            (click)="sort('title')">
            Card
            <span *ngIf="sortColumn === 'title'" class="text-blue-600">{{ sortDirection === 'asc' ? '↓' : '↑' }}</span>
        </div>
        <div class="w-40 px-4 py-2 cursor-pointer hover:bg-gray-100 flex items-center gap-1 border-r"
            (click)="sort('list')">
            List
            <span *ngIf="sortColumn === 'list'" class="text-blue-600">{{ sortDirection === 'asc' ? '↓' : '↑' }}</span>
        </div>
        <div class="w-48 px-4 py-2 border-r">Labels</div>
        <div class="w-32 px-4 py-2 border-r">Members</div>
        <div class="w-32 px-4 py-2 cursor-pointer hover:bg-gray-100 flex items-center gap-1" (click)="sort('dueDate')">
            Due Date
            <span *ngIf="sortColumn === 'dueDate'" class="text-blue-600">{{ sortDirection === 'asc' ? '↓' : '↑'
                }}</span>
        </div>
    </div>

    <!-- Scrollable Body -->
    <div class="flex-1 overflow-y-auto">
        <!-- Rows -->
        <div *ngFor="let card of getAllCards(); trackBy: trackCard"
            class="group flex items-center border-b hover:bg-gray-50 transition-colors">

            <!-- Title -->
            <div class="flex-1 px-4 py-2 border-r flex items-center gap-2 overflow-hidden">
                <div class="w-1.5 h-8 rounded-full shrink-0"
                    [style.backgroundColor]="card.labelIds?.length ? getLabelColor(card.labelIds![0]) : 'transparent'">
                </div>
                <input type="text" [value]="card.title" (blur)="updateCardTitle(card, $event)"
                    (keydown.enter)="$any($event.target).blur()"
                    [readonly]="!canEdit"
                    [class.cursor-not-allowed]="!canEdit"
                    class="w-full bg-transparent border-none p-0 focus:ring-0 text-sm font-medium text-gray-900 group-hover:bg-white/50 rounded px-1">
                <button (click)="openCard(card.id)"
                    class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                </button>
            </div>

            <!-- List -->
            <div class="w-40 px-2 py-2 border-r">
                <select (change)="updateCardList(card, $event)"
                    [disabled]="!canEdit"
                    class="w-full text-xs border-gray-200 rounded bg-white py-1 pl-2 pr-6 focus:ring-blue-500 focus:border-blue-500">
                    <option *ngFor="let l of lists()" [value]="l.id" [selected]="l.id === card.listId">{{ l.title ||
                        l.name }}</option>
                </select>
            </div>

            <!-- Labels -->
            <div class="w-48 px-4 py-2 border-r overflow-hidden">
                <div class="flex flex-wrap gap-1">
                    <!-- Add label button -->
                    <button
                        class="w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-400 hover:text-gray-600 flex items-center justify-center transition-colors"
                        title="Add/Manage Labels" (click)="openCard(card.id, 'labels')"
                        [disabled]="!canEdit"
                        [class.opacity-60]="!canEdit"
                        [class.cursor-not-allowed]="!canEdit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <!-- Actual labels -->
                    <span *ngFor="let lid of card.labelIds || []" class="inline-block w-8 h-6 rounded-full"
                        [style.backgroundColor]="getLabelColor(lid)" [title]="lid"></span>
                </div>
            </div>

            <!-- Members -->
            <div class="w-32 px-4 py-2 border-r">
                <div class="flex -space-x-2 overflow-hidden">
                    <div *ngFor="let m of card.assignees"
                        class="w-6 h-6 rounded-full ring-2 ring-white bg-gray-300 flex items-center justify-center text-[10px] text-gray-600 font-bold"
                        [title]="getMemberName(m.userId || m.id)">
                        {{ getMemberInitials(m.userId || m.id) }}
                    </div>
                    <!-- Add member button -->
                    <button
                        class="w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-400 hover:text-gray-600 ring-2 ring-white flex items-center justify-center transition-colors z-10"
                        title="Manage Members" (click)="openCard(card.id, 'members')"
                        [disabled]="!canEdit"
                        [class.opacity-60]="!canEdit"
                        [class.cursor-not-allowed]="!canEdit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Due Date -->
            <div class="w-32 px-2 py-2">
                <input type="date" [ngModel]="card.dueDate | date:'yyyy-MM-dd':'UTC'"
                    (ngModelChange)="updateDueDate(card, $event)"
                    [disabled]="!canEdit"
                    class="w-full text-xs border-none bg-transparent p-0 focus:ring-0 text-gray-500">
            </div>
        </div>

        <!-- Create Row -->
        <div class="flex items-center border-b bg-gray-50/50 p-1" *ngIf="canEdit; else viewOnlyRow">
            <div class="flex-1 px-4 py-2 flex items-center gap-2" *ngIf="showNewCardRow; else addBtn">
                <input #newCardInput type="text" [(ngModel)]="newCardTitle"
                    class="flex-1 border-gray-300 rounded px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Card title..." (keydown.enter)="createCard()"
                    (keydown.escape)="showNewCardRow = false">
                <select [(ngModel)]="newCardListId" class="border-gray-300 rounded px-2 py-1 text-sm">
                    <option *ngFor="let l of lists()" [value]="l.id">{{ l.title }}</option>
                </select>
                <button (click)="createCard()"
                    class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-bold">Add</button>
                <button (click)="showNewCardRow = false"
                    class="px-2 py-1 text-gray-500 hover:text-gray-700">Cancel</button>
            </div>
            <ng-template #addBtn>
                <button (click)="showNewCardRow = true; newCardListId = lists()[0]?.id || ''"
                    class="flex-1 text-left px-4 py-2 text-gray-500 hover:bg-gray-100 hover:text-gray-800 flex items-center gap-2 transition">
                    <span>+ Add new card</span>
                </button>
            </ng-template>
        </div>
        <ng-template #viewOnlyRow>
            <div class="flex-1 px-4 py-2 text-xs text-gray-500">
                View-only access. Ask an admin to add you as a board member to edit.
            </div>
        </ng-template>

        <!-- Empty State -->
        <div *ngIf="getAllCards().length === 0" class="p-8 text-center text-gray-500">
            No cards found.
        </div>
    </div>
</div>
