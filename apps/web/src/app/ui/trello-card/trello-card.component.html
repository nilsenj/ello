<div class="relative isolate overflow-visible bg-card-bg rounded-md px-3 py-2 mt-1 text-sm shadow-card border border-black/0 hover:border-black/5"
    [attr.aria-label]="tCardAriaLabel" (pointerup)="openModal($event)">

    <!-- Cover Image -->
    <div *ngIf="card.coverAttachment"
        class="-mx-3 -mt-2 mb-2 h-32 overflow-hidden relative group-hover:opacity-90 transition-opacity">
        <img [src]="card.coverAttachment.url" class="w-full h-full object-cover" [attr.alt]="tCoverAlt" />
    </div>
    <span *ngIf="card?.priority === 'urgent'"
        class="absolute -inset-0.5 rounded-md ring-2 ring-red-300/60 animate-pulse pointer-events-none"></span>

    <!-- left priority stripe -->
    <span *ngIf="priority() as p" class="absolute left-0 top-0 bottom-0 w-1 rounded-l" [style.backgroundColor]="p.dot"
        aria-hidden="true"></span>
    <!-- Labels row -->
    <div class="mb-2 flex flex-wrap gap-1" *ngIf="labelIds(card).length > 0">
        <span *ngFor="let lid of labelIds(card)" class="inline-block h-2 w-10 rounded"
            [style.backgroundColor]="labelColor(lid)" [attr.title]="labelName(lid)"></span>
    </div>

    <!-- Title / Inline edit -->
    <ng-container *ngIf="!editing; else editMode">
        <div class="text-ink-base" [class.line-through]="cardDone()" [class.text-ink-sub]="cardDone()">
            {{ card.title }}
        </div>
    </ng-container>

    <ng-template #editMode>
        <div class="space-y-2" data-stop-open>
            <input class="w-full rounded-md bg-white px-2 py-1 text-sm outline-none focus:ring" [(ngModel)]="titleDraft"
                (keydown)="onEditKeydown($event)" [placeholder]="tCardTitlePlaceholder" />
            <div class="flex gap-2">
                <button class="rounded-md bg-blue-600 text-white px-3 py-1 text-xs" [disabled]="!(titleDraft?.trim())"
                    (click)="saveEdit()">
                    {{ tSave }}
                </button>
                <button class="rounded-md bg-transparent px-3 py-1 text-xs text-ink-sub hover:underline"
                    (click)="cancelEdit()">
                    {{ tCancel }}
                </button>
            </div>
        </div>
    </ng-template>

    <!-- Meta row: priority • risk • estimation • dates • desc flag -->
    <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-ink-sub">
        <!-- Overdue -->
        <span *ngIf="overdue" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full bg-red-50 text-red-700">
            {{ tOverdue }}
        </span>

        <!-- Priority pill -->
        <span *ngIf="priority() as p" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full"
            [style.backgroundColor]="p.bg" [style.color]="p.fg" [attr.title]="tPriorityTitle(p.label)">
            <span class="inline-block w-2 h-2 rounded-full" [style.backgroundColor]="p.dot"></span>
            {{ p.label }}
        </span>

        <!-- Risk pill -->
        <span *ngIf="risk() as r" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full"
            [style.backgroundColor]="r.bg" [style.color]="r.fg" [attr.title]="tRiskTitle(r.label)">
            ▲ {{ r.label }}
        </span>

        <!-- Estimation -->
        <span *ngIf="estimation() !== null" class="inline-flex items-center gap-1" [attr.title]="tEstimationTitle">
            <lucide-icon [img]="ClockIcon" class="w-3 h-3"></lucide-icon>
            {{ estimation() }}
        </span>

        <!-- Dates -->
        <span *ngIf="dueInfo() as d" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full"
            [ngClass]="d.class" [attr.title]="d.title">
            <lucide-icon [img]="CalendarIcon" class="w-3 h-3"></lucide-icon>
            {{ d.text }}
        </span>

        <!-- Has description -->
        <span *ngIf="card.description" class="inline-flex items-center gap-1" [attr.title]="tHasDescription">
            <lucide-icon [img]="FileTextIcon" class="w-3 h-3"></lucide-icon>
            {{ tDescriptionShort }}
        </span>

        <!-- Right controls -->
        <div class="ml-auto">
            <button class="px-2 py-1 rounded hover:bg-white/60" (click)="showMore = !showMore; $event.stopPropagation()"
                data-stop-open>
                •••
            </button>
        </div>
    </div>

    <!-- More menu: edit / move / delete -->
    <div *ngIf="showMore" class="absolute right-2 top-12 bg-white rounded p-2 shadow border z-20"
        clickOutside (clickOutside)="showMore = false" (click)="$event.stopPropagation()" data-stop-open>
        <button type="button" class="absolute right-1 top-1 rounded px-2 py-1 text-xs hover:bg-gray-100"
            (click)="showMore = false">{{ tMoreMenuClose }}</button>

        <div class="flex flex-col gap-1">
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="startEdit()">{{ tEditTitle }}</button>

            <div *ngIf="canEdit()" class="h-px bg-gray-200 my-1"></div>

            <div *ngIf="canEdit()" class="px-2 text-[10px] uppercase tracking-wide text-gray-400">{{ tMove }}</div>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveTop()">{{ tMoveTop }}</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveUp()">{{ tMoveUp }}</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveDown()">{{ tMoveDown }}</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveBottom()">{{ tMoveBottom }}</button>

            <div *ngIf="canEdit()" class="h-px bg-gray-200 my-1"></div>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="copy()">{{ tCopy }}</button>

            <hr *ngIf="canEdit()" class="my-1 border-gray-200">
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-red-600"
                (click)="archive()">{{ tArchive }}</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-red-600"
                (click)="delete()">{{ tDelete }}</button>
        </div>
    </div>
</div>
