<div class="relative isolate overflow-hidden bg-card-bg rounded-md px-3 py-2 mt-1 text-sm shadow-card border border-black/0 hover:border-black/5"
    aria-label="Card" (click)="openModal($event)">

    <!-- Cover Image -->
    <div *ngIf="card.coverAttachment"
        class="-mx-3 -mt-2 mb-2 h-32 overflow-hidden relative group-hover:opacity-90 transition-opacity">
        <img [src]="card.coverAttachment.url" class="w-full h-full object-cover" alt="Cover" />
    </div>
    <span *ngIf="card?.priority === 'urgent'"
        class="absolute -inset-0.5 rounded-md ring-2 ring-red-300/60 animate-pulse pointer-events-none"></span>

    <!-- left priority stripe -->
    <span *ngIf="priority() as p" class="absolute left-0 top-0 bottom-0 w-1 rounded-l" [style.backgroundColor]="p.dot"
        aria-hidden="true"></span>
    <!-- hover checkbox -->
    <button class="absolute -left-2 -top-2 opacity-0 group-hover:opacity-100 transition-opacity"
        (click)="toggleDone($event)" title="Mark complete" data-stop-open>
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full border bg-white shadow"
            [class.bg-emerald-500]="cardDone()" [class.border-emerald-500]="cardDone()" [class.text-white]="cardDone()">
            <svg *ngIf="cardDone()" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-7.5 7.5a1 1 0 01-1.414 0L3.293 9.207a1 1 0 011.414-1.414L8.5 11.586l6.793-6.793a1 1 0 011.414 0z"
                    clip-rule="evenodd" />
            </svg>
            <svg *ngIf="!cardDone()" width="16" height="16" viewBox="0 0 24 24" class="text-gray-400">
                <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2" />
            </svg>
        </span>
    </button>
    <!-- Labels row -->
    <div class="mb-2 flex flex-wrap gap-1" *ngIf="labelIds(card).length > 0">
        <span *ngFor="let lid of labelIds(card)" class="inline-block h-2 w-10 rounded"
            [style.backgroundColor]="labelColor(lid)" [attr.title]="labelName(lid)"></span>
    </div>

    <!-- Title / Inline edit -->
    <ng-container *ngIf="!editing; else editMode">
        <div class="text-ink-base" [class.line-through]="cardDone()" [class.text-ink-sub]="cardDone()">
            {{ card.title }}
        </div>
    </ng-container>

    <ng-template #editMode>
        <div class="space-y-2" data-stop-open>
            <input class="w-full rounded-md bg-white px-2 py-1 text-sm outline-none focus:ring" [(ngModel)]="titleDraft"
                (keydown)="onEditKeydown($event)" placeholder="Card title‚Ä¶" />
            <div class="flex gap-2">
                <button class="rounded-md bg-blue-600 text-white px-3 py-1 text-xs" [disabled]="!(titleDraft?.trim())"
                    (click)="saveEdit()">
                    Save
                </button>
                <button class="rounded-md bg-transparent px-3 py-1 text-xs text-ink-sub hover:underline"
                    (click)="cancelEdit()">
                    Cancel
                </button>
            </div>
        </div>
    </ng-template>

    <!-- Meta row: priority ‚Ä¢ risk ‚Ä¢ estimation ‚Ä¢ dates ‚Ä¢ desc flag -->
    <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-ink-sub">
        <!-- Priority pill -->
        <span *ngIf="priority() as p" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full"
            [style.backgroundColor]="p.bg" [style.color]="p.fg" [attr.title]="'Priority: ' + p.label">
            <span class="inline-block w-2 h-2 rounded-full" [style.backgroundColor]="p.dot"></span>
            {{ p.label }}
        </span>

        <!-- Risk pill -->
        <span *ngIf="risk() as r" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full"
            [style.backgroundColor]="r.bg" [style.color]="r.fg" [attr.title]="'Risk: ' + r.label">
            ‚ñ≤ {{ r.label }}
        </span>

        <!-- Estimation -->
        <span *ngIf="estimation() !== null" [attr.title]="'Estimation'">
            ‚è± {{ estimation() }}
        </span>

        <!-- Dates -->
        <span *ngIf="dueInfo() as d" class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full"
            [ngClass]="d.class" [attr.title]="d.title">
            üóì {{ d.text }}
        </span>

        <!-- Has description -->
        <span *ngIf="card.description" class="inline-flex items-center gap-1" title="Has description">‚Ä¢ desc</span>

        <!-- Right controls -->
        <div class="ml-auto flex items-center gap-1">
            <button class="px-2 py-1 rounded hover:bg-white/60"
                (click)="showLabels = !showLabels; $event.stopPropagation()" data-stop-open>
                Labels
            </button>
            <button class="px-2 py-1 rounded hover:bg-white/60" (click)="showMore = !showMore; $event.stopPropagation()"
                data-stop-open>
                ‚Ä¢‚Ä¢‚Ä¢
            </button>
        </div>
    </div>

    <!-- Quick assign labels -->
    <div *ngIf="showLabels" class="mt-2 bg-white rounded p-2 shadow border relative" clickOutside
        (clickOutside)="showLabels = false" (click)="$event.stopPropagation()" data-stop-open>
        <button type="button" class="absolute right-1 top-1 rounded px-2 py-1 text-xs hover:bg-gray-100"
            (click)="showLabels = false">√ó</button>

        <button *ngFor="let lb of store.labels()"
            class="flex items-center gap-2 w-full text-left px-2 py-1 rounded hover:bg-gray-100"
            (click)="toggleLabel(lb.id)">
            <span class="inline-block h-3 w-3 rounded" [style.backgroundColor]="lb.color"></span>
            <span class="text-sm">{{ lb.name }}</span>
            <span class="ml-auto text-[11px]" *ngIf="has(lb.id)">‚úì</span>
        </button>
    </div>

    <!-- More menu: edit / move / delete -->
    <div *ngIf="showMore" class="mt-2 bg-white rounded p-2 shadow border relative" clickOutside
        (clickOutside)="showMore = false" (click)="$event.stopPropagation()" data-stop-open>
        <button type="button" class="absolute right-1 top-1 rounded px-2 py-1 text-xs hover:bg-gray-100"
            (click)="showMore = false">√ó</button>

        <div class="flex flex-col gap-1">
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="startEdit()">Edit
                title</button>

            <div *ngIf="canEdit()" class="h-px bg-gray-200 my-1"></div>

            <div *ngIf="canEdit()" class="px-2 text-[10px] uppercase tracking-wide text-gray-400">Move</div>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveTop()">Move to
                top</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveUp()">Move up</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveDown()">Move down</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="moveBottom()">Move to
                bottom</button>

            <div *ngIf="canEdit()" class="h-px bg-gray-200 my-1"></div>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 rounded hover:bg-gray-100"
                (click)="copy()">Copy</button>

            <hr *ngIf="canEdit()" class="my-1 border-gray-200">
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-red-600"
                (click)="archive()">Archive</button>
            <button *ngIf="canEdit()" class="w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-red-600"
                (click)="delete()">Delete</button>
        </div>
    </div>
</div>