<!-- Board header -->
<div class="flex items-center justify-between gap-3 px-4 py-3 bg-[color:var(--board-bg,#0f6ad4)] text-white relative">
    <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
        <kanban-filters
                [filter]="filter"
                (filterChange)="filter = $event"
                [activeLabel]="activeLabel"
                (activeLabelChange)="updateActiveLabel($event)"
                [activeMemberId]="activeMemberId"
                (activeMemberIdChange)="updateActiveMember($event)"
                [activeOverdue]="activeOverdue"
                (activeOverdueChange)="activeOverdue = $event"
                [labels]="store.labels()"
                [members]="store.members()"
                [tFilterPlaceholder]="tFilterPlaceholder"
                [tAllLabels]="tAllLabels"
                [tLabelDefault]="tLabelDefault"
                [tAllMembers]="tAllMembers"
                [tMemberDefault]="tMemberDefault"
                [tFilters]="tFilters"
                [tSearchCards]="tSearchCards"
                [tSearchPlaceholder]="tSearchPlaceholder"
                [tLabel]="tLabel"
                [tMember]="tMember"
                [tClearFilters]="tClearFilters"
                [tOverdueFilter]="tOverdueFilter"
                (menuOpened)="onFiltersOpened()">
        </kanban-filters>
    </div>

    <div class="flex items-center gap-2 sm:gap-3 shrink-0">
        <!-- View Dropdown -->
        <div class="relative hidden sm:block">
            <button
                    class="flex bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded items-center gap-2 transition font-medium text-sm"
                    (click)="toggleViewMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 5h16M4 12h16m-7 6h7"/>
                </svg>
                <span class="hidden md:inline">{{ tView }}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 opacity-80" viewBox="0 0 20 20"
                     fill="currentColor">
                    <path fill-rule="evenodd"
                          d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                          clip-rule="evenodd"/>
                </svg>
            </button>

            <!-- Backdrop -->
            <div *ngIf="showViewMenu" class="fixed inset-0 z-20 cursor-default" (click)="closeViewMenu()"></div>

            <!-- Menu -->
            <div *ngIf="showViewMenu"
                 class="absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-30 border border-gray-200 text-gray-800">

                <!-- Board View Link -->
                <a [routerLink]="[]" [queryParams]="{view: null}" queryParamsHandling="merge" (click)="closeViewMenu()"
                   class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center gap-2 text-gray-700"
                   [class.bg-blue-50]="currentView() === 'board'" [class.text-blue-700]="currentView() === 'board'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
                         [class.text-blue-700]="currentView() === 'board'"
                         [class.text-slate-500]="currentView() !== 'board'" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                    </svg>
                    {{ tBoardView }}
                </a>

                <!-- Table View Link -->
                <a [routerLink]="[]" [queryParams]="{view: 'table'}" queryParamsHandling="merge"
                   (click)="closeViewMenu()"
                   class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center gap-2 text-gray-700"
                   [class.bg-blue-50]="currentView() === 'table'" [class.text-blue-700]="currentView() === 'table'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
                         [class.text-blue-700]="currentView() === 'table'"
                         [class.text-slate-500]="currentView() !== 'table'" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    {{ tTableView }}
                </a>

                <!-- Calendar View Link -->
                <a [routerLink]="[]" [queryParams]="{view: 'calendar'}" queryParamsHandling="merge"
                   (click)="closeViewMenu()"
                   class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center gap-2 text-gray-700"
                   [class.bg-blue-50]="currentView() === 'calendar'"
                   [class.text-blue-700]="currentView() === 'calendar'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
                         [class.text-blue-700]="currentView() === 'calendar'"
                         [class.text-slate-500]="currentView() !== 'calendar'" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    {{ tCalendarView }}
                </a>
            </div>
        </div>

        <!-- Service Desk Settings + Board Menu Button -->
        <a *ngIf="isServiceDeskBoard() && currentBoardWorkspaceId()"
           [routerLink]="['/w', currentBoardWorkspaceId(), 'service-desk', 'overview']"
           class="text-sm bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded flex items-center gap-2 transition font-medium"
           [attr.aria-label]="tServiceDeskSettings">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 9.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z"/>
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.01A1.65 1.65 0 009.5 3.6V3a2 2 0 014 0v.09c0 .66.38 1.26.97 1.51h.01a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.01c.25.6.85.97 1.51.97H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
            <span class="hidden md:inline">{{ tServiceDeskSettings }}</span>
        </a>
        <a *ngIf="isFulfillmentBoard() && currentBoardWorkspaceId()"
           [routerLink]="['/w', currentBoardWorkspaceId(), 'ecommerce-fulfillment', 'overview']"
           class="text-sm bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded flex items-center gap-2 transition font-medium"
           [attr.aria-label]="tFulfillmentSettings">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 9.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z"/>
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.01A1.65 1.65 0 009.5 3.6V3a2 2 0 014 0v.09c0 .66.38 1.26.97 1.51h.01a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.01c.25.6.85.97 1.51.97H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
            <span class="hidden md:inline">{{ tFulfillmentSettings }}</span>
        </a>
        <button
                class="text-sm bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded flex items-center gap-2 transition font-medium"
                (click)="menu.open()">
            <span class="hidden sm:inline">•••</span>
            <span class="sm:hidden">{{ tMenu }}</span>
            <span class="hidden sm:inline">{{ tShowMenu }}</span>
        </button>
    </div>
</div>

<div *ngIf="showWorkspaceViewerBanner()" class="board-banner" role="status" aria-live="polite">
    <span class="board-banner-dot" aria-hidden="true"></span>
    <span class="board-banner-text">
        {{ tViewOnlyBanner }}
    </span>
</div>


<board-menu #menu></board-menu>

<!-- Mobile Toolbar -->
<div class="flex items-center gap-2 px-4 py-2 bg-white/5 md:hidden">
    <!-- Mobile Add List -->
    <button class="w-full text-sm bg-white/90 text-gray-800 px-3 py-1.5 rounded shadow-sm font-medium"
            (click)="focusNewList()">
        {{ tAddListMobile }}
    </button>
</div>


<!-- Table View -->
<board-table-view *ngIf="currentView() === 'table'" [cards]="getAllFilteredCards()" [canEdit]="canEditBoard()"
                  class="flex-1 overflow-hidden bg-slate-50"></board-table-view>

<!-- Calendar View -->
<board-calendar-view *ngIf="currentView() === 'calendar'" [cards]="getAllFilteredCards()" [canEdit]="canEditBoard()"
                     class="flex-1 overflow-hidden bg-white"></board-calendar-view>

<!-- Lists (Board View) -->
<div *ngIf="currentView() === 'board'" class="p-4 overflow-x-auto min-h-screen transition-colors"
     [ngClass]="boardBackground()" [style.backgroundImage]="boardBackgroundStyle()">
    <!-- Horizontal list reordering -->
    <div cdkDropList [cdkDropListData]="lists()" [cdkDropListOrientation]="'horizontal'"
         [cdkDropListDisabled]="!canEditBoard()"
         (cdkDropListDropped)="onListDropped($event)" class="flex gap-4 min-h-[70vh]">
        <!-- Each column is a draggable item -->
        <div *ngFor="let l of lists(); trackBy: trackList" cdkDrag cdkDragLockAxis="x"
             [cdkDragDisabled]="!canEditBoard()" class="list-shell w-72 shrink-0">
            <!-- drag preview -->
            <ng-template cdkDragPreview>
                <div class="list-preview w-72 rounded-xl">
                    <div class="h-9 flex items-center px-3 font-semibold">
                        {{ l.title || l.name }}
                    </div>
                    <div class="h-40 opacity-70"></div>
                </div>
            </ng-template>

            <!-- placeholder -->
            <ng-template cdkDragPlaceholder>
                <div class="list-placeholder w-72 h-[320px] rounded-xl"></div>
            </ng-template>

            <!-- Your actual column (cards DnD remains inside) -->
            <list-column [list]="l" [filtered]="cards(l.id)" [canEdit]="canEditBoard()" [overdueMap]="overdueMap()">
            </list-column>
        </div>

        <!-- Add list -->
        <section *ngIf="canEditBoard()" class="w-72 shrink-0 rounded-xl p-3 transition-colors"
                 [ngClass]="isLightBoard() ? 'bg-black/5 hover:bg-black/10' : 'bg-white/30 text-white/95'">
            <div *ngIf="!newListTitle">
                <button class="w-full rounded-md py-2 transition-colors text-left pl-2 font-medium"
                        [ngClass]="isLightBoard() ? 'text-gray-600 hover:text-gray-800 hover:bg-black/5' : 'bg-white/30 hover:bg-white/40'"
                        (click)="newListTitle = tNewList">
                    {{ tAddAnotherList }}
                </button>
            </div>

            <div *ngIf="newListTitle" class="space-y-2">
                <input #newListInput
                       class="w-full rounded-md bg-white px-2 py-1 text-sm text-gray-800 outline-none focus:ring"
                       [(ngModel)]="newListTitle" (keydown.enter)="addList()" [placeholder]="tListTitlePlaceholder"/>
                <div *ngIf="isServiceDeskBoard() || isFulfillmentBoard()" class="space-y-1">
                    <label class="text-[11px] font-semibold text-slate-600 uppercase tracking-wide">{{ tListStatusLabel }}</label>
                    <select
                            class="ui-select w-full rounded-md border border-gray-200 bg-white px-2 py-1 text-sm text-gray-800 outline-none focus:border-blue-400"
                            [(ngModel)]="newListStatusKey">
                        <option value="">{{ tSelectStatus }}</option>
                        <option *ngFor="let opt of statusOptions()" [value]="opt.key">
                            {{ opt.label }}
                        </option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button class="rounded-md bg-blue-600 text-white px-3 py-1 text-sm"
                            [disabled]="!newListTitle.trim() || ((isServiceDeskBoard() || isFulfillmentBoard()) && !newListStatusKey)"
                            (click)="addList()">{{ tAddList }}
                    </button>
                    <button class="rounded-md bg-transparent px-3 py-1 text-sm hover:underline"
                            [class.text-gray-700]="isLightBoard()" (click)="newListTitle = ''">{{ tCancel }}
                    </button>
                </div>
            </div>
        </section>
    </div>
</div>

<card-modal></card-modal>
