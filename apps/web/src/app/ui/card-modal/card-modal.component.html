<div *ngIf="modal.isOpen()" class="cm-backdrop" (click)="close()"></div>

<div *ngIf="modal.isOpen()" class="cm-panel" role="dialog" [ngClass]="priorityClass()" aria-modal="true"
    (click)="$event.stopPropagation()">
    <div class="cm-header">
        <span class="cm-header-accent" aria-hidden="true"></span>

        <span class="cm-header-pill" *ngIf="(data()?.priority || priorityDraft()) as p">{{ p }}</span>

        <input class="cm-title" [ngModel]="titleDraft()" (ngModelChange)="titleDraft.set($event)" (blur)="saveTitle()"
            (keydown.enter)="saveTitle()"
            [attr.aria-label]="'Card title. Priority: ' + ((data()?.priority || priorityDraft()) || 'none')" />

        <button class="cm-close" (click)="close()" aria-label="Close">
            <lucide-icon [img]="XIcon"></lucide-icon>
        </button>
    </div>

    <div class="cm-body" *ngIf="!loading(); else loadingTpl">
        <!-- Left column -->
        <div class="cm-col cm-col-main">
            <!-- Description -->
            <section>
                <div class="cm-section-title">Description</div>

                <div *ngIf="!isEditingDesc && !descDraft()?.trim()" class="cm-btn inline-flex items-center"
                    (click)="startDescEdit()">
                    <lucide-icon [img]="PlusIcon" class="mr-1"></lucide-icon>
                    Add a more detailed description…
                </div>

                <div *ngIf="!isEditingDesc && (descDraft()?.trim()?.length || 0) > 0" class="space-y-2">
                    <div class="prose prose-sm max-w-none cm-description"
                        [innerHTML]="richDescription(descDraft()) | safeHtml"></div>
                    <div>
                        <button class="cm-btn inline-flex items-center" (click)="startDescEdit()">
                            <lucide-icon [img]="PencilIcon" class="mr-1"></lucide-icon>
                            Edit
                        </button>
                    </div>
                </div>

                <div *ngIf="isEditingDesc" class="space-y-3">
                    <div
                        class="border border-slate-300 rounded-md overflow-hidden focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 shadow-sm transition-all duration-200">
                        <!-- Toolbar -->
                        <div class="bg-gray-50 border-b border-slate-200 px-2 py-1.5 flex gap-1 items-center">
                            <button type="button"
                                class="p-1.5 rounded hover:bg-slate-200 text-slate-600 hover:text-slate-900 transition-colors"
                                (click)="wrapSelection(descInput, '**','**')" title="Bold">
                                <lucide-icon [img]="BoldIcon" class="w-4 h-4"></lucide-icon>
                            </button>
                            <button type="button"
                                class="p-1.5 rounded hover:bg-slate-200 text-slate-600 hover:text-slate-900 transition-colors"
                                (click)="wrapSelection(descInput, '_','_')" title="Italic">
                                <lucide-icon [img]="ItalicIcon" class="w-4 h-4"></lucide-icon>
                            </button>
                            <div class="w-px h-4 bg-slate-300 mx-1"></div>
                            <button type="button"
                                class="p-1.5 rounded hover:bg-slate-200 text-slate-600 hover:text-slate-900 transition-colors"
                                (click)="insertPrefix(descInput, '- ')" title="List">
                                <lucide-icon [img]="ListIcon" class="w-4 h-4"></lucide-icon>
                            </button>
                            <button type="button"
                                class="p-1.5 rounded hover:bg-slate-200 text-slate-600 hover:text-slate-900 transition-colors"
                                (click)="makeHeading(descInput)" title="Heading">
                                <lucide-icon [img]="Heading1Icon" class="w-4 h-4"></lucide-icon>
                            </button>
                            <div class="w-px h-4 bg-slate-300 mx-1"></div>
                            <button type="button"
                                class="p-1.5 rounded hover:bg-slate-200 text-slate-600 hover:text-slate-900 transition-colors"
                                (click)="insertLink(descInput)" title="Link">
                                <lucide-icon [img]="LinkIcon" class="w-4 h-4"></lucide-icon>
                            </button>
                        </div>

                        <!-- Textarea -->
                        <textarea #descInput
                            class="w-full min-h-[160px] p-3 text-sm focus:outline-none bg-white resize-y cm-textarea"
                            rows="8" [ngModel]="descDraft()" (ngModelChange)="descDraft.set($event)"
                            placeholder="Add a more detailed description…"></textarea>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex gap-2">
                            <button class="cm-btn-primary inline-flex items-center" (click)="saveDescription()">
                                Save
                            </button>
                            <button class="cm-btn inline-flex items-center" (click)="cancelDescEdit()">
                                Cancel
                            </button>
                        </div>
                        <span class="text-xs text-slate-400">
                            {{ descCharCount() | number }} characters
                        </span>
                    </div>
                </div>
            </section>

            <!-- Comments -->
            <section>
                <div class="cm-section-title">Comments</div>

                <div class="cm-comment-editor">
                    <textarea rows="3" class="cm-textarea" [ngModel]="commentDraft()"
                        (ngModelChange)="commentDraft.set($event)" placeholder="Write a comment…"></textarea>
                    <div class="mt-2">
                        <button class="cm-btn-primary inline-flex items-center" type="button"
                            [disabled]="isCommentBlank()" (click)="addComment()">
                            <lucide-icon [img]="SendIcon" class="mr-1"></lucide-icon>
                            Comment
                        </button>
                    </div>
                </div>

                <div class="cm-comments">
                    <div *ngFor="let c of comments()" class="cm-comment">
                        <div class="cm-comment-meta">
                            <span class="cm-author">{{ c.author?.name || 'User' }}</span>
                            <span class="cm-dot">•</span>
                            <span class="cm-date">{{ c.createdAt | date: 'medium' }}</span>
                            <button class="cm-link inline-flex items-center ml-auto" (click)="deleteComment(c.id)">
                                <lucide-icon [img]="Trash2Icon" class="mr-1"></lucide-icon>
                                Delete
                            </button>
                        </div>
                        <div class="cm-comment-text">{{ c.text }}</div>
                    </div>
                </div>
            </section>

            <!-- Activity -->
            <section>
                <div class="cm-section-title flex items-center gap-2">
                    <lucide-icon [img]="ActivityIcon" class="text-slate-500"></lucide-icon>
                    Activity
                </div>
                <div class="cm-comments">
                    <div *ngFor="let act of activities()" class="cm-comment">
                        <div class="flex gap-3 text-sm">
                            <div
                                class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center shrink-0 overflow-hidden">
                                <img *ngIf="act.user?.avatar" [src]="act.user.avatar"
                                    class="w-full h-full object-cover">
                                <span *ngIf="!act.user?.avatar" class="text-xs font-medium text-slate-600">
                                    {{ (act.user?.name || 'U').slice(0,2).toUpperCase() }}
                                </span>
                            </div>
                            <div>
                                <p class="text-slate-800">
                                    <span class="font-semibold">{{ act.user?.name || 'User' }}</span>
                                    {{ formatActivity(act) }}
                                </p>
                                <p class="text-xs text-slate-500 mt-0.5">{{ act.createdAt | date:'MMM d, h:mm a' }}</p>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="activities().length === 0" class="text-sm text-slate-500 italic pl-11">
                        No activity yet.
                    </div>
                </div>
            </section>
        </div>

        <!-- Right column (side panel) -->
        <div class="cm-col cm-col-side">
            <!-- Compact chips -->
            <section
                *ngIf="selectedLabelIds().size || startDraft() || dueDraft() || hasAnyMembers() || checklists().length || hasPlanning() || hasAttachments()">
                <div class="cm-section-title">Card details</div>
                <div class="flex flex-wrap gap-2">
                    <button *ngIf="selectedLabelIds().size" class="cm-chip" (click)="openPanel('labels')">
                        <lucide-icon [img]="TagIcon" class="mr-1"></lucide-icon>
                        Labels ({{ selectedLabelIds().size }})
                    </button>

                    <button *ngIf="startDraft() || dueDraft()" class="cm-chip" (click)="openPanel('dates')">
                        <lucide-icon [img]="CalendarIcon" class="mr-1"></lucide-icon>
                        Dates
                        <span *ngIf="startDraft()">• Start</span>
                        <span *ngIf="dueDraft()">• Due</span>
                    </button>

                    <button *ngIf="hasAnyMembers()" class="cm-chip" (click)="openPanel('members')">
                        <lucide-icon [img]="UsersIcon" class="mr-1"></lucide-icon>
                        Members ({{ currentMemberIds().length }})
                    </button>

                    <button *ngIf="checklists().length" class="cm-chip" (click)="openPanel('checklists')">
                        <lucide-icon [img]="ListChecksIcon" class="mr-1"></lucide-icon>
                        Checklists ({{ checklists().length }})
                    </button>

                    <button *ngIf="hasPlanning()" class="cm-chip" (click)="openPanel('planning')">
                        <lucide-icon [img]="GaugeIcon" class="mr-1"></lucide-icon>
                        Planning
                        <span *ngIf="currentPriority"> • {{ currentPriority }}</span>
                        <span *ngIf="currentRisk"> • risk: {{ currentRisk }}</span>
                        <span *ngIf="currentEstimate !== ''"> • est: {{ currentEstimate }}</span>
                    </button>

                    <button *ngIf="hasAttachments()" class="cm-chip" (click)="openPanel('attachments')">
                        <lucide-icon [img]="PaperclipIcon" class="mr-1"></lucide-icon>
                        Attachments ({{ attachments()?.length }})
                    </button>
                </div>
            </section>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Add to card -->
                <section>
                    <div class="cm-section-title">Add to card</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="cm-add inline-flex items-center" (click)="openPanel('labels')">
                            <lucide-icon [img]="TagIcon" class="mr-1"></lucide-icon>
                            Labels
                        </button>
                        <button class="cm-add inline-flex items-center" (click)="openPanel('members')">
                            <lucide-icon [img]="UsersIcon" class="mr-1"></lucide-icon>
                            Members
                        </button>
                        <button class="cm-add inline-flex items-center" (click)="openPanel('dates')">
                            <lucide-icon [img]="CalendarIcon" class="mr-1"></lucide-icon>
                            Dates
                        </button>
                        <button class="cm-add inline-flex items-center" (click)="openPanel('checklists')">
                            <lucide-icon [img]="ListChecksIcon" class="mr-1"></lucide-icon>
                            Checklist
                        </button>
                        <button class="cm-add inline-flex items-center" (click)="openPanel('attachments')">
                            <lucide-icon [img]="PaperclipIcon" class="mr-1"></lucide-icon>
                            Attachment
                        </button>
                        <button class="cm-add inline-flex items-center" (click)="openPanel('planning')">
                            <lucide-icon [img]="GaugeIcon" class="mr-1"></lucide-icon>
                            Planning
                        </button>
                    </div>
                </section>

                <!-- Panels for Add to Card -->
                <!-- Labels -->
                <section *ngIf="isPanelOpen('labels')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="TagIcon" class="mr-1"></lucide-icon>
                            Labels
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <div class="cm-labels">
                        <button *ngFor="let lb of (store.labels() || [])" class="cm-label"
                            [class.is-selected]="selectedLabelIds().has(lb.id)" [style.--c]="lb.color"
                            (click)="toggleLabel(lb.id)">
                            <span class="cm-dot" [style.backgroundColor]="lb.color"></span>
                            <span>{{ lb.name }}</span>
                            <span class="cm-check" *ngIf="selectedLabelIds().has(lb.id)">✓</span>
                        </button>
                    </div>
                </section>

                <!-- Dates -->
                <section *ngIf="isPanelOpen('dates')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="CalendarIcon" class="mr-1"></lucide-icon>
                            Dates
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <label class="cm-field">
                        <span class="cm-field-label">Start</span>
                        <input type="datetime-local" class="cm-input" [ngModel]="startDraft()"
                            (ngModelChange)="startDraft.set($event || null); setDates('start', $event || null)" />
                    </label>

                    <label class="cm-field">
                        <span class="cm-field-label">Due</span>
                        <input type="datetime-local" class="cm-input" [ngModel]="dueDraft()"
                            (ngModelChange)="dueDraft.set($event || null); setDates('due', $event || null)" />
                    </label>
                </section>

                <!-- Members -->
                <ng-container *ngIf="isPanelOpen('members') && data() as c">
                    <members-panel [cardId]="c.id" [assigneesInput]="(c.assignees ?? [])"
                        (assigneesChange)="onAssigneesChange($event)" (closePanel)="closePanel()" />
                </ng-container>

                <!-- Checklists -->
                <section *ngIf="isPanelOpen('checklists')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            Checklists
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <div class="cm-checklist" *ngFor="let cl of checklists()">
                        <div class="cm-checklist-header flex items-center gap-2">
                            <input class="cm-input flex-1 font-semibold" [ngModel]="cl.title"
                                (ngModelChange)="renameChecklist(cl.id, $event)" />
                            <button class="cm-icon-btn text-gray-400 hover:text-red-600"
                                (click)="deleteChecklist(cl.id)" title="Delete checklist">
                                <lucide-icon [img]="Trash2Icon" class="w-4 h-4"></lucide-icon>
                            </button>
                        </div>

                        <div class="cm-checklist-progress my-2" *ngIf="cl.items.length > 0">
                            <div class="text-xs text-gray-500 mb-1">
                                {{ (cl.items | filterBy: 'done': true).length }}/{{ cl.items.length }}
                            </div>
                            <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 transition-all duration-300"
                                    [style.width.%]="((cl.items | filterBy: 'done': true).length / cl.items.length) * 100">
                                </div>
                            </div>
                        </div>

                        <ul class="cm-checklist-items space-y-1">
                            <li *ngFor="let it of cl.items"
                                class="cm-checklist-item group flex items-start gap-2 hover:bg-gray-50 p-1 rounded -mx-1">
                                <input type="checkbox" class="mt-1" [checked]="it.done"
                                    (change)="toggleChecklistItem(cl.id, it.id, $any($event.target).checked)" />
                                <input class="flex-1 bg-transparent border-none p-0 text-sm focus:ring-0"
                                    [class.line-through]="it.done" [class.text-gray-500]="it.done" [ngModel]="it.text"
                                    (blur)="updateChecklistItemText(cl.id, it.id, $any($event.target).value)"
                                    (keydown.enter)="$any($event.target).blur()" />
                                <button class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-600 p-0.5"
                                    (click)="deleteChecklistItem(cl.id, it.id)" title="Delete item">
                                    <lucide-icon [img]="XIcon" class="w-3 h-3"></lucide-icon>
                                </button>
                            </li>
                        </ul>

                        <button class="cm-btn inline-flex items-center mt-2 text-xs" (click)="addChecklistItem(cl.id)">
                            <lucide-icon [img]="PlusIcon" class="mr-1 w-3 h-3"></lucide-icon>
                            Add item
                        </button>
                    </div>

                    <button class="cm-btn inline-flex items-center mt-2" (click)="addChecklist()">
                        <lucide-icon [img]="PlusIcon" class="mr-1"></lucide-icon>
                        Add checklist
                    </button>
                </section>

                <!-- Attachments -->
                <section *ngIf="isPanelOpen('attachments')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="PaperclipIcon" class="mr-1"></lucide-icon>
                            Attachments
                        </span>
                        <span class="cm-badge ml-2" *ngIf="attachments()?.length">{{ attachments()?.length }}</span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <!-- Add new -->
                    <div class="space-y-3">
                        <!-- Drag & Drop + Button -->
                        <div class="cm-dropzone" [class.is-active]="dropActive()" tabindex="0" role="button"
                            aria-label="Upload files. You can also drag and drop." (dragover)="onDragOver($event)"
                            (dragleave)="onDragLeave($event)" (drop)="onDropFiles($event)"
                            (keydown.enter)="openHiddenFileInput.click()" (keydown.space)="openHiddenFileInput.click()">
                            <input #openHiddenFileInput type="file" class="sr-only" multiple
                                (change)="addAttachmentFiles($event.target)" accept="image/*,video/*,audio/*,application/pdf,
                    application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,
                    application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,
                    application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,
                    text/plain,text/markdown,text/csv,application/json,.zip,.rar,.7z" />
                            <div class="cm-dropzone-inner">
                                <div class="cm-dropzone-icon">
                                    <lucide-icon [img]="PlusIcon"></lucide-icon>
                                </div>
                                <div class="cm-dropzone-text">
                                    <strong>Upload files</strong> or drop them here
                                    <span class="cm-muted block">PNG, JPG, PDF, DOCX, ZIP…</span>
                                </div>
                                <button type="button" class="cm-btn ml-auto" (click)="openHiddenFileInput.click()">
                                    Choose files
                                </button>
                            </div>
                        </div>

                        <!-- Attach by URL -->
                        <div class="flex items-center gap-2">
                            <input class="cm-input flex-1" placeholder="https://example.com/file.png"
                                [ngModel]="attachUrlDraft()" (ngModelChange)="attachUrlDraft.set($event)" />
                            <button class="cm-btn inline-flex items-center" (click)="addAttachmentByUrl()">
                                <lucide-icon [img]="PlusIcon" class="mr-1"></lucide-icon>
                                Attach URL
                            </button>
                        </div>

                        <div class="cm-uploading" *ngIf="isUploading()">
                            <span class="cm-spinner" aria-hidden="true"></span>
                            <span>Uploading…</span>
                        </div>
                    </div>

                    <!-- List -->
                    <div class="cm-attachments mt-3" *ngIf="attachments()?.length; else noAttTpl">
                        <div class="cm-attachment" *ngFor="let a of attachments()">
                            <div class="cm-attachment-thumb">
                                <!-- Preview heuristic -->
                                <ng-container *ngIf="isImage(a); else typeThumb">
                                    <img [src]="attachmentApiFileUrl(a)" alt="" />
                                </ng-container>

                                <ng-template #typeThumb>
                                    <ng-container *ngIf="isVideo(a); else audioOrDoc">
                                        <video [src]="safeMediaUrl(attachmentApiFileUrl(a))" class="cm-attachment-video"
                                            controls></video>
                                    </ng-container>

                                    <ng-template #audioOrDoc>
                                        <ng-container *ngIf="isAudio(a); else docThumb">
                                            <audio [src]="safeMediaUrl(attachmentApiFileUrl(a))"
                                                class="cm-attachment-audio" controls></audio>
                                        </ng-container>

                                        <ng-template #docThumb>
                                            <ng-container *ngIf="isPdf(a); else genericIcon">
                                                <iframe [src]="safeMediaUrl(attachmentApiFileUrl(a))"
                                                    class="cm-attachment-pdf" title="PDF preview"></iframe>
                                            </ng-container>

                                            <ng-template #genericIcon>
                                                <div class="cm-attachment-icon">
                                                    <lucide-icon [img]="FileTextIcon"></lucide-icon>
                                                </div>
                                            </ng-template>
                                        </ng-template>
                                    </ng-template>

                                    <div class="cm-attachment-cover" *ngIf="a.isCover">Cover</div>
                                </ng-template>

                                <!-- Hover overlay quick actions -->
                                <div class="cm-attachment-overlay">
                                    <button class="cm-overlay-btn" (click)="previewAttachment(a)" aria-label="Open">
                                        Open
                                    </button>
                                    <button *ngIf="isImage(a) && !a.isCover" class="cm-overlay-btn mt-2"
                                        (click)="setAsCover(a.id)" aria-label="Make Cover">
                                        Make Cover
                                    </button>
                                    <button *ngIf="a.isCover" class="cm-overlay-btn mt-2" (click)="removeCover(a.id)"
                                        aria-label="Remove Cover">
                                        Remove Cover
                                    </button>
                                </div>
                            </div>

                            <div class="cm-attachment-body">
                                <div class="cm-attachment-row">
                                    <div class="cm-attachment-name" *ngIf="renameDraftId() !== a.id; else renameTpl">
                                        {{ a.name || 'attachment' }}
                                    </div>
                                    <span class="cm-ext-badge">{{ fileExt(a) }}</span>
                                </div>

                                <div class="cm-attachment-meta">
                                    <span class="cm-muted">{{ a.mime || 'file' }}</span>
                                    <span class="cm-meta-dot"></span>
                                    <span class="cm-muted">{{ humanBytes(a.size ?? 0) }}</span>
                                    <span class="cm-meta-dot"></span>

                                    <button class="cm-link inline-flex items-center" (click)="downloadAttachment(a)"
                                        [disabled]="isDownloading(a.id)" aria-label="Download">
                                        <lucide-icon [img]="DownloadIcon" class="mr-1"></lucide-icon>
                                        <ng-container *ngIf="!isDownloading(a.id); else dlProg">Download</ng-container>
                                    </button>
                                    <ng-template #dlProg>{{ downloadPercent(a.id) }}%</ng-template>
                                </div>

                                <div class="cm-progress" *ngIf="isDownloading(a.id)">
                                    <div class="cm-progress-bar" [style.width.%]="downloadPercent(a.id)"></div>
                                </div>

                                <div class="cm-actionbar">
                                    <button class="cm-action" (click)="startRename(a)" aria-label="Rename">
                                        <lucide-icon [img]="PencilIcon" class="mr-1"></lucide-icon>
                                        <span>Rename</span>
                                    </button>

                                    <button class="cm-action cm-action--danger" (click)="removeAttachment(a.id)"
                                        aria-label="Delete">
                                        <lucide-icon [img]="Trash2Icon" class="mr-1"></lucide-icon>
                                        <span>Delete</span>
                                    </button>
                                </div>
                            </div>

                            <ng-template #renameTpl>
                                <div class="flex items-center gap-2">
                                    <input class="cm-input" [ngModel]="renameDraftName()"
                                        (ngModelChange)="renameDraftName.set($event)" />
                                    <button class="cm-btn-primary inline-flex items-center" (click)="saveRename()">
                                        <lucide-icon [img]="SaveIcon" class="mr-1"></lucide-icon>
                                        Save
                                    </button>
                                    <button class="cm-btn inline-flex items-center" (click)="cancelRename()">
                                        <lucide-icon [img]="XCircleIcon" class="mr-1"></lucide-icon>
                                        Cancel
                                    </button>
                                </div>
                            </ng-template>
                        </div>
                    </div>

                    <ng-template #noAttTpl>
                        <div class="cm-empty">
                            <div class="cm-empty-icon">
                                <lucide-icon [img]="PaperclipIcon"></lucide-icon>
                            </div>
                            <div class="cm-empty-text">No attachments yet.</div>
                            <div class="cm-empty-sub">Upload files or attach a URL to get started.</div>
                        </div>
                    </ng-template>
                </section>

                <!-- Planning -->
                <section *ngIf="isPanelOpen('planning')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="GaugeIcon" class="mr-1"></lucide-icon>
                            Planning
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <label class="cm-field">
                        <span class="cm-field-label">Priority</span>
                        <select class="cm-input" [ngModel]="priorityDraft()" (ngModelChange)="savePriority($event)">
                            <option value="">—</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </label>

                    <label class="cm-field">
                        <span class="cm-field-label">Risk</span>
                        <select class="cm-input" [ngModel]="riskDraft()" (ngModelChange)="saveRisk($event)">
                            <option value="">—</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </label>

                    <label class="cm-field">
                        <span class="cm-field-label">Estimation</span>
                        <input type="number" min="0" step="0.5" class="cm-input" placeholder="e.g. 3"
                            [ngModel]="estimationDraft()" (ngModelChange)="saveEstimation($event ?? '')" />
                        <small class="cm-muted">Story Points</small>
                    </label>
                </section>

                <!-- Actions -->
                <section>
                    <div class="cm-section-title">Actions</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button *ngIf="canEdit()" class="cm-add inline-flex items-center" (click)="archiveCard()">
                            <lucide-icon [img]="ArchiveIcon" class="mr-1"></lucide-icon>
                            Archive
                        </button>
                        <button *ngIf="canEdit()" class="cm-add inline-flex items-center"
                            (click)="prepareMoveOrCopy('move')">
                            <lucide-icon [img]="MoveIcon" class="mr-1"></lucide-icon>
                            Move
                        </button>
                        <button *ngIf="canEdit()" class="cm-add inline-flex items-center"
                            (click)="prepareMoveOrCopy('copy')">
                            <lucide-icon [img]="CopyIcon" class="mr-1"></lucide-icon>
                            Copy
                        </button>
                        <button *ngIf="canEdit()" class="cm-add inline-flex items-center text-red-600 hover:bg-red-50"
                            (click)="deleteCard()">
                            <lucide-icon [img]="Trash2Icon" class="mr-1"></lucide-icon>
                            Delete
                        </button>
                    </div>
                </section>

                <!-- Move Actions -->
                <section *ngIf="isPanelOpen('move')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="MoveIcon" class="mr-1"></lucide-icon>
                            Move Card
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <div class="space-y-3">
                        <label class="cm-field">
                            <span class="cm-field-label">Board</span>
                            <select class="cm-input" [ngModel]="targetBoardId()"
                                (ngModelChange)="onTargetBoardChange($event)">
                                <option *ngFor="let b of availableBoards()" [value]="b.id">{{ b.name }}</option>
                            </select>
                        </label>

                        <label class="cm-field">
                            <span class="cm-field-label">List</span>
                            <div *ngIf="isBusyAction()" class="cm-muted text-xs mb-1">Loading lists...</div>
                            <select class="cm-input" [ngModel]="targetListId()"
                                (ngModelChange)="targetListId.set($event)" [disabled]="isBusyAction()">
                                <option *ngFor="let l of targetLists()" [value]="l.id">{{ l.title || l.name }}</option>
                            </select>
                        </label>

                        <label class="cm-field">
                            <span class="cm-field-label">Position</span>
                            <select class="cm-input" [ngModel]="targetPosition()"
                                (ngModelChange)="targetPosition.set($event)">
                                <option value="top">Top</option>
                                <option value="bottom">Bottom</option>
                            </select>
                        </label>

                        <button class="cm-btn-primary w-full justify-center" (click)="doMove()"
                            [disabled]="isBusyAction() || !targetListId()">
                            Move
                        </button>
                    </div>
                </section>

                <!-- Copy Actions -->
                <section *ngIf="isPanelOpen('copy')">
                    <div class="cm-section-title flex items-center gap-2">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="CopyIcon" class="mr-1"></lucide-icon>
                            Copy Card
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <div class="space-y-3">
                        <label class="cm-field">
                            <span class="cm-field-label">Title</span>
                            <textarea class="cm-input" rows="2" [ngModel]="copyTitle()"
                                (ngModelChange)="copyTitle.set($event)"></textarea>
                        </label>

                        <label class="cm-field">
                            <span class="cm-field-label">Board</span>
                            <select class="cm-input" [ngModel]="targetBoardId()"
                                (ngModelChange)="onTargetBoardChange($event)">
                                <option *ngFor="let b of availableBoards()" [value]="b.id">{{ b.name }}</option>
                            </select>
                        </label>

                        <label class="cm-field">
                            <span class="cm-field-label">List</span>
                            <div *ngIf="isBusyAction()" class="cm-muted text-xs mb-1">Loading lists...</div>
                            <select class="cm-input" [ngModel]="targetListId()"
                                (ngModelChange)="targetListId.set($event)" [disabled]="isBusyAction()">
                                <option *ngFor="let l of targetLists()" [value]="l.id">{{ l.title || l.name }}</option>
                            </select>
                        </label>

                        <button class="cm-btn-primary w-full justify-center" (click)="doCopy()"
                            [disabled]="isBusyAction() || !targetListId() || !copyTitle().trim()">
                            Copy
                        </button>
                    </div>
                </section>

                <!-- Delete Actions -->
                <section *ngIf="isPanelOpen('delete')">
                    <div class="cm-section-title flex items-center gap-2 text-red-700">
                        <span class="inline-flex items-center">
                            <lucide-icon [img]="Trash2Icon" class="mr-1"></lucide-icon>
                            Delete Card?
                        </span>
                        <button class="cm-link inline-flex items-center ml-auto text-ink-base" (click)="closePanel()">
                            <lucide-icon [img]="XIcon"></lucide-icon>
                            Close
                        </button>
                    </div>

                    <div class="space-y-3">
                        <p class="text-sm text-ink-sub">
                            All actions will be removed from the activity feed and you won't be able to re-open the
                            card.
                            There is no undo.
                        </p>

                        <button
                            class="cm-btn-primary w-full justify-center bg-red-600 hover:bg-red-700 text-white border-transparent"
                            (click)="doDelete()" [disabled]="isBusyAction()">
                            {{ isBusyAction() ? 'Deleting...' : 'Delete' }}
                        </button>
                    </div>
                </section>

            </div>
        </div>

        <ng-template #loadingTpl>
            <div class="cm-loading">Loading…</div>
        </ng-template>
    </div>