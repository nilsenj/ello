<div *ngIf="modal.isOpen()" class="cm-backdrop" (click)="close()"></div>

<div *ngIf="modal.isOpen()" class="cm-panel" role="dialog" [ngClass]="priorityClass()" aria-modal="true"
     (click)="$event.stopPropagation()">
    <div class="cm-header">
        <span class="cm-header-accent" aria-hidden="true"></span>

        <span class="cm-header-pill" *ngIf="(data()?.priority || priorityDraft()) as p">{{ p }}</span>

        <input class="cm-title" [ngModel]="titleDraft()" (ngModelChange)="titleDraft.set($event)" (blur)="saveTitle()"
               (keydown.enter)="saveTitle()"
               [readonly]="!canEdit()"
               [class.cursor-not-allowed]="!canEdit()"
               [attr.aria-label]="tCardTitleAria((data()?.priority || priorityDraft()) || tNone)"/>
        <button class="cm-close" (click)="close()" [attr.aria-label]="tClose">
            <lucide-icon [img]="XIcon"></lucide-icon>
        </button>
    </div>

    <div class="cm-body" *ngIf="!loading(); else loadingTpl">
        <!-- Left column -->
        <div class="cm-col cm-col-main">
            <card-modal-description class="cm-block cm-block-description"
                                    [cardId]="data()?.id"
                                    [description]="data()?.description"
                                    [canEdit]="canEdit()"
                                    (descriptionSaved)="onDescriptionSaved($event)"
                                    [PlusIcon]="PlusIcon"
                                    [PencilIcon]="PencilIcon" [BoldIcon]="BoldIcon" [ItalicIcon]="ItalicIcon"
                                    [ListIcon]="ListIcon" [Heading1Icon]="Heading1Icon" [LinkIcon]="LinkIcon"/>

            <card-modal-comments class="cm-block cm-block-comments"
                                 [cardId]="data()?.id"
                                 [comments]="comments()"
                                 [SendIcon]="SendIcon" [Trash2Icon]="Trash2Icon"
                                 [canEdit]="canEdit()"
                                 (commentsUpdated)="onCommentsUpdated($event)"/>

            <card-modal-activity class="cm-block cm-block-activity" [activities]="activities()"
                                 [formatActivity]="formatActivity" [ActivityIcon]="ActivityIcon"/>
        </div>

        <!-- Right column (side panel) -->
        <div class="cm-col cm-col-side">
            <card-modal-details class="cm-block cm-block-details" [labelCount]="selectedLabelIds().size"
                                [hasStart]="!!startDraft()" [hasDue]="!!dueDraft()"
                                [memberCount]="currentMemberIds().length" [checklistCount]="checklists().length"
                                [hasPlanning]="hasPlanning()" [hasAttachments]="hasAttachments()"
                                [attachmentCount]="attachments().length" [currentPriority]="currentPriority"
                                [currentRisk]="currentRisk" [currentEstimate]="currentEstimate" [TagIcon]="TagIcon"
                                [CalendarIcon]="CalendarIcon" [UsersIcon]="UsersIcon"
                                [ListChecksIcon]="ListChecksIcon" [GaugeIcon]="GaugeIcon"
                                [PaperclipIcon]="PaperclipIcon" (openPanel)="openPanel($event)"/>

            <div class="cm-side-stack space-y-6">
                <div class="cm-block cm-block-fulfillment rounded-xl border border-slate-200 bg-white p-4 space-y-3"
                     *ngIf="isFulfillmentBoard()">
                    <div class="flex items-center justify-between">
                        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{ tFulfillment }}</div>
                        <button class="cm-btn-primary inline-flex items-center gap-1"
                                (click)="saveFulfillment()"
                                [disabled]="!canEdit() || fulfillmentSaving()">
                            <lucide-icon [img]="SaveIcon"></lucide-icon>
                            {{ tSave }}
                        </button>
                    </div>

                    <label class="block space-y-1">
                        <span class="text-xs font-medium text-slate-500">{{ tOrderNumber }}</span>
                        <input class="cm-input"
                               [ngModel]="fulfillmentDraft().orderNumber"
                               (ngModelChange)="setFulfillmentField('orderNumber', $event)"
                               [readonly]="!canEdit()"
                               [class.cursor-not-allowed]="!canEdit()"/>
                    </label>

                    <label class="block space-y-1">
                        <span class="text-xs font-medium text-slate-500">{{ tItemsSummary }}</span>
                        <textarea class="cm-textarea"
                                  [ngModel]="fulfillmentDraft().itemsSummary"
                                  (ngModelChange)="setFulfillmentField('itemsSummary', $event)"
                                  [readonly]="!canEdit()"
                                  [class.cursor-not-allowed]="!canEdit()"></textarea>
                    </label>

                    <div class="grid grid-cols-2 gap-2">
                        <label class="block space-y-1">
                            <span class="text-xs font-medium text-slate-500">{{ tOrderTotal }}</span>
                            <input class="cm-input" type="number" step="0.01" inputmode="decimal"
                                   [ngModel]="fulfillmentDraft().orderTotal"
                                   (ngModelChange)="setFulfillmentField('orderTotal', $event)"
                                   [readonly]="!canEdit()"
                                   [class.cursor-not-allowed]="!canEdit()"/>
                        </label>
                        <label class="block space-y-1">
                            <span class="text-xs font-medium text-slate-500">{{ tOrderCurrency }}</span>
                            <input class="cm-input"
                                   [ngModel]="fulfillmentDraft().orderCurrency"
                                   (ngModelChange)="setFulfillmentField('orderCurrency', $event)"
                                   [readonly]="!canEdit()"
                                   [class.cursor-not-allowed]="!canEdit()"/>
                        </label>
                    </div>

                    <label class="block space-y-1">
                        <span class="text-xs font-medium text-slate-500">{{ tPaidAt }}</span>
                        <input class="cm-input" type="datetime-local"
                               [ngModel]="fulfillmentDraft().paidAt"
                               (ngModelChange)="setFulfillmentField('paidAt', $event)"
                               [readonly]="!canEdit()"
                               [class.cursor-not-allowed]="!canEdit()"/>
                    </label>

                    <div class="grid grid-cols-2 gap-2">
                        <label class="block space-y-1">
                            <span class="text-xs font-medium text-slate-500">{{ tShippingCarrier }}</span>
                            <input class="cm-input"
                                   [ngModel]="fulfillmentDraft().shippingCarrier"
                                   (ngModelChange)="setFulfillmentField('shippingCarrier', $event)"
                                   [readonly]="!canEdit()"
                                   [class.cursor-not-allowed]="!canEdit()"/>
                        </label>
                        <label class="block space-y-1">
                            <span class="text-xs font-medium text-slate-500">{{ tTrackingNumber }}</span>
                            <input class="cm-input"
                                   [ngModel]="fulfillmentDraft().trackingNumber"
                                   (ngModelChange)="setFulfillmentField('trackingNumber', $event)"
                                   [readonly]="!canEdit()"
                                   [class.cursor-not-allowed]="!canEdit()"/>
                        </label>
                    </div>

                    <div class="space-y-1 text-xs text-slate-600" *ngIf="data()?.trackingUrl">
                        <div class="text-xs font-medium text-slate-500">{{ tTrackingLink }}</div>
                        <a class="inline-flex items-center gap-1 text-blue-600 break-all"
                           [href]="data()?.trackingUrl" target="_blank" rel="noreferrer">
                            <lucide-icon [img]="ExternalLinkIcon"></lucide-icon>
                            {{ data()?.trackingUrl }}
                        </a>
                    </div>
                </div>

                <card-modal-add-to-card class="cm-block cm-block-add" [openPanel]="openPanel"
                                        [closePanel]="closePanel" [isPanelOpen]="isPanelOpen"
                                        [labels]="store.labels() || []" [selectedLabelIds]="selectedLabelIds()"
                                        [toggleLabel]="toggleLabel"
                                        [isEditingLabel]="isEditingLabel" [labelDraftId]="labelDraftId"
                                        [labelNameDraft]="labelNameDraft"
                                        [labelColorDraft]="labelColorDraft" [labelColors]="labelColors"
                                        [startCreateLabel]="startCreateLabel" [startEditLabel]="startEditLabel"
                                        [cancelLabelEdit]="cancelLabelEdit" [saveLabel]="saveLabel"
                                        [deleteLabel]="deleteLabel"
                                        [startDraft]="startDraft" [dueDraft]="dueDraft" [setDates]="setDates"
                                        [card]="data()"
                                        [onAssigneesChange]="onAssigneesChange" [checklists]="checklists()"
                                        [addChecklist]="addChecklist"
                                        [renameChecklist]="renameChecklist" [deleteChecklist]="deleteChecklist"
                                        [addChecklistItem]="addChecklistItem"
                                        [toggleChecklistItem]="toggleChecklistItem"
                                        [updateChecklistItemText]="updateChecklistItemText"
                                        [deleteChecklistItem]="deleteChecklistItem"
                                        [priorityDraft]="priorityDraft" [riskDraft]="riskDraft"
                                        [estimationDraft]="estimationDraft"
                                        [savePriority]="savePriority" [saveRisk]="saveRisk"
                                        [saveEstimation]="saveEstimation"
                                        [attachments]="attachments()" [attachUrlDraft]="attachUrlDraft"
                                        [renameDraftId]="renameDraftId"
                                        [renameDraftName]="renameDraftName" [isUploading]="isUploading"
                                        [dropActive]="dropActive"
                                        [addAttachmentByUrl]="addAttachmentByUrl"
                                        [addAttachmentFiles]="addAttachmentFiles"
                                        [onDragOver]="onDragOver" [onDragLeave]="onDragLeave"
                                        [onDropFiles]="onDropFiles"
                                        [isImage]="isImage" [isVideo]="isVideo" [isAudio]="isAudio" [isPdf]="isPdf"
                                        [isExternal]="isExternal" [safeMediaUrl]="safeMediaUrl"
                                        [attachmentApiFileUrl]="attachmentApiFileUrl" [setAsCover]="setAsCover"
                                        [removeCover]="removeCover" [previewAttachment]="previewAttachment"
                                        [downloadAttachment]="downloadAttachment" [isDownloading]="isDownloading"
                                        [downloadPercent]="downloadPercent" [humanBytes]="humanBytes"
                                        [startRename]="startRename"
                                        [cancelRename]="cancelRename" [saveRename]="saveRename" [fileExt]="fileExt"
                                        [removeAttachment]="removeAttachment" [TagIcon]="TagIcon"
                                        [CalendarIcon]="CalendarIcon"
                                        [UsersIcon]="UsersIcon" [ListChecksIcon]="ListChecksIcon"
                                        [PaperclipIcon]="PaperclipIcon"
                                        [GaugeIcon]="GaugeIcon" [PlusIcon]="PlusIcon" [PencilIcon]="PencilIcon"
                                        [CheckIcon]="CheckIcon"
                                        [ChevronLeftIcon]="ChevronLeftIcon" [XIcon]="XIcon" [Trash2Icon]="Trash2Icon"
                                        [FileTextIcon]="FileTextIcon" [ExternalLinkIcon]="ExternalLinkIcon"
                                        [DownloadIcon]="DownloadIcon"
                                        [SaveIcon]="SaveIcon" [XCircleIcon]="XCircleIcon"
                                        [canEdit]="canEdit()"/>

                <card-modal-actions class="cm-block cm-block-actions"
                                    [canArchive]="canEdit()"
                                    [canMoveCopy]="canEdit()"
                                    [canDelete]="canAdmin()"
                                    [isPanelOpen]="isPanelOpen" [closePanel]="closePanel"
                                    [archiveCard]="archiveCard" [prepareMoveOrCopy]="prepareMoveOrCopy"
                                    [deleteCard]="deleteCard"
                                    [availableBoards]="availableBoards()" [targetBoardId]="targetBoardId"
                                    [targetLists]="targetLists()" [targetListId]="targetListId"
                                    [targetPosition]="targetPosition"
                                    [copyTitle]="copyTitle" [isBusyAction]="isBusyAction"
                                    [onTargetBoardChange]="onTargetBoardChange"
                                    [doMove]="doMove" [doCopy]="doCopy" [doDelete]="doDelete"
                                    [ArchiveIcon]="ArchiveIcon"
                                    [MoveIcon]="MoveIcon" [CopyIcon]="CopyIcon" [Trash2Icon]="Trash2Icon"
                                    [XIcon]="XIcon"/>
            </div>
        </div>

        <ng-template #loadingTpl>
            <div class="cm-loading">{{ tLoading }}</div>
        </ng-template>
    </div>
</div>
