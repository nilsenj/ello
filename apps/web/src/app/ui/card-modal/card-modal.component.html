<div *ngIf="modal.isOpen()" class="cm-backdrop" (click)="close()"></div>

<div *ngIf="modal.isOpen()" class="cm-panel" role="dialog" [ngClass]="priorityClass()" aria-modal="true"
     (click)="$event.stopPropagation()">
    <div class="cm-header">
        <span class="cm-header-accent" aria-hidden="true"></span>

        <span class="cm-header-pill" *ngIf="(data()?.priority || priorityDraft()) as p">{{ p }}</span>

        <input class="cm-title" [ngModel]="titleDraft()" (ngModelChange)="titleDraft.set($event)" (blur)="saveTitle()"
               (keydown.enter)="saveTitle()"
               [readonly]="!canEdit()"
               [class.cursor-not-allowed]="!canEdit()"
               [attr.aria-label]="'Card title. Priority: ' + ((data()?.priority || priorityDraft()) || 'none')"/>

        <button class="cm-close" (click)="close()" aria-label="Close">
            <lucide-icon [img]="XIcon"></lucide-icon>
        </button>
    </div>

    <div class="cm-body" *ngIf="!loading(); else loadingTpl">
        <!-- Left column -->
        <div class="cm-col cm-col-main">
            <card-modal-description class="cm-block cm-block-description" [descDraft]="descDraft"
                                    [isEditingDesc]="isEditingDesc" [descCharCount]="descCharCount"
                                    [startDescEdit]="startDescEdit" [saveDescription]="saveDescription"
                                    [cancelDescEdit]="cancelDescEdit" [wrapSelection]="wrapSelection"
                                    [insertPrefix]="insertPrefix" [makeHeading]="makeHeading"
                                    [insertLink]="insertLink" [richDescription]="richDescription" [PlusIcon]="PlusIcon"
                                    [PencilIcon]="PencilIcon" [BoldIcon]="BoldIcon" [ItalicIcon]="ItalicIcon"
                                    [ListIcon]="ListIcon" [Heading1Icon]="Heading1Icon" [LinkIcon]="LinkIcon"
                                    [canEdit]="canEdit()"/>

            <card-modal-comments class="cm-block cm-block-comments" [commentDraft]="commentDraft"
                                 [comments]="comments()"
                                 [isCommentBlank]="isCommentBlank" [addComment]="addComment"
                                 [deleteComment]="deleteComment"
                                 [SendIcon]="SendIcon" [Trash2Icon]="Trash2Icon"
                                 [canEdit]="canEdit()"/>

            <card-modal-activity class="cm-block cm-block-activity" [activities]="activities()"
                                 [formatActivity]="formatActivity" [ActivityIcon]="ActivityIcon"/>
        </div>

        <!-- Right column (side panel) -->
        <div class="cm-col cm-col-side">
            <card-modal-details class="cm-block cm-block-details" [labelCount]="selectedLabelIds().size"
                                [hasStart]="!!startDraft()" [hasDue]="!!dueDraft()"
                                [memberCount]="currentMemberIds().length" [checklistCount]="checklists().length"
                                [hasPlanning]="hasPlanning()" [hasAttachments]="hasAttachments()"
                                [attachmentCount]="attachments().length" [currentPriority]="currentPriority"
                                [currentRisk]="currentRisk" [currentEstimate]="currentEstimate" [TagIcon]="TagIcon"
                                [CalendarIcon]="CalendarIcon" [UsersIcon]="UsersIcon"
                                [ListChecksIcon]="ListChecksIcon" [GaugeIcon]="GaugeIcon"
                                [PaperclipIcon]="PaperclipIcon" (openPanel)="openPanel($event)"/>

            <div class="cm-side-stack space-y-6">
                <card-modal-add-to-card class="cm-block cm-block-add" [openPanel]="openPanel"
                                        [closePanel]="closePanel" [isPanelOpen]="isPanelOpen"
                                        [labels]="store.labels() || []" [selectedLabelIds]="selectedLabelIds()"
                                        [toggleLabel]="toggleLabel"
                                        [isEditingLabel]="isEditingLabel" [labelDraftId]="labelDraftId"
                                        [labelNameDraft]="labelNameDraft"
                                        [labelColorDraft]="labelColorDraft" [labelColors]="labelColors"
                                        [startCreateLabel]="startCreateLabel" [startEditLabel]="startEditLabel"
                                        [cancelLabelEdit]="cancelLabelEdit" [saveLabel]="saveLabel"
                                        [deleteLabel]="deleteLabel"
                                        [startDraft]="startDraft" [dueDraft]="dueDraft" [setDates]="setDates"
                                        [card]="data()"
                                        [onAssigneesChange]="onAssigneesChange" [checklists]="checklists()"
                                        [addChecklist]="addChecklist"
                                        [renameChecklist]="renameChecklist" [deleteChecklist]="deleteChecklist"
                                        [addChecklistItem]="addChecklistItem"
                                        [toggleChecklistItem]="toggleChecklistItem"
                                        [updateChecklistItemText]="updateChecklistItemText"
                                        [deleteChecklistItem]="deleteChecklistItem"
                                        [priorityDraft]="priorityDraft" [riskDraft]="riskDraft"
                                        [estimationDraft]="estimationDraft"
                                        [savePriority]="savePriority" [saveRisk]="saveRisk"
                                        [saveEstimation]="saveEstimation"
                                        [attachments]="attachments()" [attachUrlDraft]="attachUrlDraft"
                                        [renameDraftId]="renameDraftId"
                                        [renameDraftName]="renameDraftName" [isUploading]="isUploading"
                                        [dropActive]="dropActive"
                                        [addAttachmentByUrl]="addAttachmentByUrl"
                                        [addAttachmentFiles]="addAttachmentFiles"
                                        [onDragOver]="onDragOver" [onDragLeave]="onDragLeave"
                                        [onDropFiles]="onDropFiles"
                                        [isImage]="isImage" [isVideo]="isVideo" [isAudio]="isAudio" [isPdf]="isPdf"
                                        [isExternal]="isExternal" [safeMediaUrl]="safeMediaUrl"
                                        [attachmentApiFileUrl]="attachmentApiFileUrl" [setAsCover]="setAsCover"
                                        [removeCover]="removeCover" [previewAttachment]="previewAttachment"
                                        [downloadAttachment]="downloadAttachment" [isDownloading]="isDownloading"
                                        [downloadPercent]="downloadPercent" [humanBytes]="humanBytes"
                                        [startRename]="startRename"
                                        [cancelRename]="cancelRename" [saveRename]="saveRename" [fileExt]="fileExt"
                                        [removeAttachment]="removeAttachment" [TagIcon]="TagIcon"
                                        [CalendarIcon]="CalendarIcon"
                                        [UsersIcon]="UsersIcon" [ListChecksIcon]="ListChecksIcon"
                                        [PaperclipIcon]="PaperclipIcon"
                                        [GaugeIcon]="GaugeIcon" [PlusIcon]="PlusIcon" [PencilIcon]="PencilIcon"
                                        [CheckIcon]="CheckIcon"
                                        [ChevronLeftIcon]="ChevronLeftIcon" [XIcon]="XIcon" [Trash2Icon]="Trash2Icon"
                                        [FileTextIcon]="FileTextIcon" [ExternalLinkIcon]="ExternalLinkIcon"
                                        [DownloadIcon]="DownloadIcon"
                                        [SaveIcon]="SaveIcon" [XCircleIcon]="XCircleIcon"
                                        [canEdit]="canEdit()"/>

                <card-modal-actions class="cm-block cm-block-actions"
                                    [canArchive]="canEdit()"
                                    [canMoveCopy]="canEdit()"
                                    [canDelete]="canAdmin()"
                                    [isPanelOpen]="isPanelOpen" [closePanel]="closePanel"
                                    [archiveCard]="archiveCard" [prepareMoveOrCopy]="prepareMoveOrCopy"
                                    [deleteCard]="deleteCard"
                                    [availableBoards]="availableBoards()" [targetBoardId]="targetBoardId"
                                    [targetLists]="targetLists()" [targetListId]="targetListId"
                                    [targetPosition]="targetPosition"
                                    [copyTitle]="copyTitle" [isBusyAction]="isBusyAction"
                                    [onTargetBoardChange]="onTargetBoardChange"
                                    [doMove]="doMove" [doCopy]="doCopy" [doDelete]="doDelete"
                                    [ArchiveIcon]="ArchiveIcon"
                                    [MoveIcon]="MoveIcon" [CopyIcon]="CopyIcon" [Trash2Icon]="Trash2Icon"
                                    [XIcon]="XIcon"/>
            </div>
        </div>

        <ng-template #loadingTpl>
            <div class="cm-loading">Loadingâ€¦</div>
        </ng-template>
    </div>
</div>
